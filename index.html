<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="TranslatePro - è¶…è¶Š DeepL çš„ AI ç¿»è¯‘å·¥å…·ï¼Œæˆæœ¬ä»…ä¸ºå…¶ 1%">
    <meta name="keywords" content="ç¿»è¯‘,AIç¿»è¯‘,DeepL,GPT-4,Claude,DeepSeek,å…è´¹ç¿»è¯‘">
    <title>TranslatePro - AIé©±åŠ¨çš„ä¸“ä¸šç¿»è¯‘å·¥å…·</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        :root {
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            background: #f5f5f5;
            color: #2b2b2b;
            min-height: 100vh;
            /* iOS Safari ä¼˜åŒ– */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* é˜²æ­¢æ¨ªå‘æ»šåŠ¨ */
            overflow-x: hidden;
            width: 100%;
        }

        /* Header */
        header {
            background: white;
            border-bottom: 1px solid #e3e3e3;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 22px;
            font-weight: 700;
            color: #0f2b46;
            text-decoration: none;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0f2b46 0%, #1a4971 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-settings {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #d4d4d4;
            border-radius: 6px;
            color: #4a4a4a;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-settings:hover {
            background: #f9f9f9;
            border-color: #0f2b46;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid #e3e3e3;
            padding-bottom: 0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #6b6b6b;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: #2b2b2b;
        }

        .tab.active {
            color: #0f2b46;
            border-bottom-color: #0f2b46;
        }

        /* Translation Area */
        .translation-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 24px;
        }

        /* Language Selector Bar */
        .language-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #e3e3e3;
            background: #fafafa;
        }

        .language-select-wrapper {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .language-select {
            appearance: none;
            background: white;
            border: 1px solid #d4d4d4;
            border-radius: 6px;
            padding: 8px 32px 8px 12px;
            font-size: 14px;
            font-weight: 500;
            color: #2b2b2b;
            cursor: pointer;
            min-width: 180px;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%234a4a4a' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: all 0.2s;
        }

        .language-select:hover {
            border-color: #0f2b46;
        }

        .language-select:focus {
            outline: none;
            border-color: #0f2b46;
            box-shadow: 0 0 0 3px rgba(15, 43, 70, 0.1);
        }

        .swap-btn {
            width: 36px;
            height: 36px;
            background: white;
            border: 1px solid #d4d4d4;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .swap-btn:hover:not(:disabled) {
            background: #f9f9f9;
            border-color: #0f2b46;
        }

        .swap-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Style Options */
        .style-options {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            background: #fafafa;
            border-bottom: 1px solid #e3e3e3;
            overflow-x: auto;
        }

        .style-option {
            padding: 6px 16px;
            background: white;
            border: 1px solid #d4d4d4;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: #4a4a4a;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .style-option:hover {
            border-color: #0f2b46;
            color: #0f2b46;
        }

        .style-option.active {
            background: #0f2b46;
            color: white;
            border-color: #0f2b46;
        }

        /* Text Areas */
        .text-areas {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 400px;
        }

        .text-box {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .text-box:first-child {
            border-right: 1px solid #e3e3e3;
        }

        .text-box-header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e3e3e3;
            min-height: 56px;
        }

        .char-count {
            font-size: 13px;
            color: #8a8a8a;
        }

        .text-box-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: #6b6b6b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #f0f0f0;
            color: #2b2b2b;
        }

        textarea {
            flex: 1;
            padding: 20px;
            border: none;
            font-size: 16px;
            line-height: 1.6;
            color: #2b2b2b;
            resize: none;
            outline: none;
            background: white;
            /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
            -webkit-appearance: none;
            /* é˜²æ­¢ iOS è‡ªåŠ¨ç¼©æ”¾ */
            max-width: 100%;
        }

        textarea::placeholder {
            color: #b0b0b0;
        }

        textarea:disabled {
            background: #fafafa;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(250, 250, 250, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e3e3e3;
            border-top-color: #0f2b46;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Info Banner */
        .info-banner {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #4a4a4a;
        }

        .info-banner-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .provider-status {
            font-size: 12px;
            color: #7a7a7a;
        }

        .shortcut-hint {
            margin-top: 10px;
            color: #7a7a7a;
            font-size: 12px;
        }

        .info-banner .status-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #e3e3e3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2b2b2b;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: #8a8a8a;
            font-size: 24px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #2b2b2b;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #4a4a4a;
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d4d4d4;
            border-radius: 6px;
            font-size: 14px;
            color: #2b2b2b;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #0f2b46;
            box-shadow: 0 0 0 3px rgba(15, 43, 70, 0.1);
        }

        .form-input::placeholder {
            color: #b0b0b0;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: #0f2b46;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #1a4971;
        }

        .btn-primary:active {
            transform: translateY(1px);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #2b2b2b;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 2000;
        }

        .toast.show {
            display: flex;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                height: auto;
                min-height: 60px;
                padding: 8px 12px;
            }

            body {
                overflow-x: hidden;
            }

            .container {
                padding: 16px 12px;
                padding-bottom: calc(16px + var(--safe-bottom));
            }

            .text-areas {
                grid-template-columns: 1fr;
                min-height: 0;
            }

            .text-box:first-child {
                border-right: none;
                border-bottom: 1px solid #e3e3e3;
            }

            .language-bar {
                padding: 12px 16px;
            }

            .language-select-wrapper {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }

            .language-select {
                width: 100%;
                min-width: auto;
                min-height: 44px;
                font-size: 16px;
            }

            .swap-btn {
                align-self: center;
                transform: rotate(90deg);
                width: 44px;
                height: 44px;
            }

            .style-options {
                padding: 12px 16px;
                gap: 6px;
            }

            .style-option {
                font-size: 12px;
                padding: 5px 12px;
            }

            .tabs {
                flex-direction: row;
                gap: 4px;
            }

            .tab {
                flex: 1;
                min-height: 44px;
                padding: 10px 12px;
                font-size: 14px;
            }

            textarea {
                font-size: 15px;
                padding: 16px;
                min-height: 220px;
            }

            .modal {
                margin: 12px;
                max-width: calc(100vw - 24px);
            }

            .header-content {
                padding: 12px 16px;
            }

            .logo {
                font-size: 18px;
            }

            .logo-icon {
                width: 28px;
                height: 28px;
            }

            .btn-settings {
                min-height: 40px;
                padding: 8px 12px;
                font-size: 13px;
            }

            .info-banner {
                font-size: 13px;
                padding: 12px 16px;
            }

            .shortcut-hint {
                display: none;
            }

            .text-box-header {
                padding: 12px 16px;
                min-height: 52px;
            }

            .icon-btn {
                width: 40px;
                height: 40px;
            }

            .toast {
                left: 12px;
                right: 12px;
                bottom: calc(12px + var(--safe-bottom));
                width: auto;
            }

            /* é˜²æ­¢æ¨¡æ€æ¡†è¶…å‡ºå±å¹• */
            .modal-overlay {
                padding: 12px;
            }

            /* ç¡®ä¿æ–‡æœ¬æ¡†ä¸ä¼šæº¢å‡º */
            .text-areas,
            .text-box,
            textarea {
                max-width: 100%;
                overflow-x: hidden;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 375px) {
            .logo {
                font-size: 16px;
                gap: 8px;
            }

            .logo span {
                display: none;
            }

            .btn-settings {
                padding: 6px 10px;
                font-size: 12px;
            }

            .btn-settings svg {
                width: 14px;
                height: 14px;
            }

            .tab {
                font-size: 13px;
                padding: 8px 12px;
            }

            .style-option {
                font-size: 11px;
                padding: 4px 10px;
            }

            textarea {
                font-size: 14px;
            }
        }

        /* Scrollbar */
        textarea::-webkit-scrollbar {
            width: 8px;
        }

        textarea::-webkit-scrollbar-track {
            background: transparent;
        }

        textarea::-webkit-scrollbar-thumb {
            background: #d4d4d4;
            border-radius: 4px;
        }

        textarea::-webkit-scrollbar-thumb:hover {
            background: #b0b0b0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <a href="#" class="logo">
            <div class="logo-icon">TP</div>
            <span>TranslatePro</span>
        </a>
        <div class="header-actions">
            <button class="btn-settings" onclick="openSettings()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                API è®¾ç½®
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('translate')">ç¿»è¯‘</button>
            <button class="tab" onclick="switchTab('improve')">æ”¹è¿›æ–‡æœ¬</button>
        </div>

        <!-- Translation Container -->
        <div class="translation-container">
            <!-- Language Bar -->
            <div id="languageBar" class="language-bar">
                <div class="language-select-wrapper">
                    <select id="sourceLang" class="language-select" onchange="handleLanguageChange()">
                        <option value="auto">ğŸŒ è‡ªåŠ¨æ£€æµ‹</option>
                        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                        <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    </select>
                    <button id="swapBtn" class="swap-btn" onclick="swapLanguages()" title="äº¤æ¢è¯­è¨€">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                        </svg>
                    </button>
                    <select id="targetLang" class="language-select" onchange="handleLanguageChange()">
                        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                        <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    </select>
                </div>
            </div>

            <!-- Style Options -->
            <div id="styleOptions" class="style-options">
                <button class="style-option active" onclick="selectStyle('standard')">æ ‡å‡†</button>
                <button class="style-option" onclick="selectStyle('formal')">æ­£å¼</button>
                <button class="style-option" onclick="selectStyle('casual')">å£è¯­åŒ–</button>
                <button class="style-option" onclick="selectStyle('literary')">æ–‡å­¦</button>
                <button class="style-option" onclick="selectStyle('technical')">ä¸“ä¸šæœ¯è¯­</button>
            </div>

            <!-- Text Areas -->
            <div class="text-areas">
                <!-- Source Text -->
                <div class="text-box">
                    <div class="text-box-header">
                        <span class="char-count"><span id="sourceCount">0</span> / 5000 å­—ç¬¦</span>
                        <div class="text-box-actions">
                            <!-- ç¿»è¯‘æŒ‰é’®ï¼ˆä»…ç¿»è¯‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
                            <button id="translateBtn" class="icon-btn" onclick="manualTranslate()" title="ç¿»è¯‘" style="display: none;">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                                </svg>
                            </button>
                            <!-- æ”¹è¿›æŒ‰é’®ï¼ˆä»…æ”¹è¿›æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
                            <button id="improveBtn" class="icon-btn" onclick="manualImprove()" title="æ”¹è¿›æ–‡æœ¬" style="display: none;">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                </svg>
                            </button>
                            <button id="clearBtn" class="icon-btn" onclick="clearSource()" title="æ¸…é™¤" style="display: none;">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <textarea id="sourceText" placeholder="è¾“å…¥æ–‡æœ¬å¼€å§‹ç¿»è¯‘..." oninput="handleInput()" maxlength="5000"></textarea>
                </div>

                <!-- Target Text -->
                <div class="text-box">
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                    </div>
                    <div class="text-box-header">
                        <span class="char-count"><span id="targetCount">0</span> å­—ç¬¦</span>
                        <div class="text-box-actions">
                            <button id="copyBtn" class="icon-btn" onclick="copyText()" title="å¤åˆ¶" style="display: none;">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <textarea id="targetText" placeholder="ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly disabled></textarea>
                </div>
            </div>
        </div>

        <!-- Info Banner -->
        <div class="info-banner">
            <div class="status-dot"></div>
            <div class="info-banner-content">
                <span>ç”± <strong id="currentProvider">DeepSeek</strong> æä¾›æ”¯æŒ Â· é«˜ç²¾åº¦ AI ç¿»è¯‘å¼•æ“</span>
                <span id="providerStatus" class="provider-status">å°±ç»ª</span>
            </div>
        </div>
        <div class="shortcut-hint">å¿«æ·é”®ï¼šCtrl/Cmd + Enter ç«‹å³æ‰§è¡Œ Â· Ctrl/Cmd + K èšç„¦è¾“å…¥æ¡† Â· Esc æ¸…ç©ºè¾“å…¥</div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay" onclick="closeModalOnOutsideClick(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">API é…ç½®</h2>
                <button class="modal-close" onclick="closeSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">API æä¾›å•†</label>
                    <select id="apiProvider" class="form-select" onchange="updateModels()">
                        <option value="deepseek">DeepSeek</option>
                        <option value="openai">OpenAI</option>
                        <option value="claude">Anthropic Claude</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æ¨¡å‹</label>
                    <select id="apiModel" class="form-select">
                        <option value="deepseek-chat">deepseek-chat</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" id="apiKey" class="form-input" placeholder="sk-...">
                    <div style="margin-top: 8px; font-size: 12px; color: #8a8a8a;">
                        æ‚¨çš„ API Key ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šè¢«ä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚
                        <span id="keyStatus" style="display: block; margin-top: 4px; color: #22c55e;"></span>
                    </div>
                </div>
                
                <!-- ç¿»è¯‘æ¨¡å¼è®¾ç½® -->
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e3e3e3;">
                    <div class="form-label" style="margin-bottom: 12px;">ç¿»è¯‘æ¨¡å¼</div>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #d4d4d4; border-radius: 8px; transition: all 0.2s;" id="autoModeLabel">
                            <input type="radio" name="translationMode" value="auto" id="autoModeRadio" style="margin-top: 2px; cursor: pointer;">
                            <div>
                                <div style="font-size: 14px; font-weight: 500; color: #2b2b2b;">å®æ—¶ç¿»è¯‘</div>
                                <div style="font-size: 12px; color: #8a8a8a; margin-top: 4px;">è¾“å…¥å 2 ç§’è‡ªåŠ¨ç¿»è¯‘ï¼Œä½“éªŒæµç•…</div>
                            </div>
                        </label>
                        
                        <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #d4d4d4; border-radius: 8px; transition: all 0.2s;" id="manualModeLabel">
                            <input type="radio" name="translationMode" value="manual" id="manualModeRadio" style="margin-top: 2px; cursor: pointer;">
                            <div>
                                <div style="font-size: 14px; font-weight: 500; color: #2b2b2b;">æ‰‹åŠ¨ç¿»è¯‘</div>
                                <div style="font-size: 12px; color: #8a8a8a; margin-top: 4px;">ç‚¹å‡»æŒ‰é’®ç¿»è¯‘ï¼ŒèŠ‚çœ API æˆæœ¬</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <button class="btn-primary" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // åº”ç”¨çŠ¶æ€
        const state = {
            activeTab: 'translate',
            translationStyle: 'standard',
            sourceLang: 'auto',
            targetLang: 'en',
            apiConfig: {
                provider: localStorage.getItem('apiProvider') || 'deepseek',
                model: localStorage.getItem('apiModel') || 'deepseek-chat',
                // ä¸ºæ¯ä¸ªæä¾›å•†å•ç‹¬å­˜å‚¨ API Key
                apiKeys: {
                    deepseek: localStorage.getItem('apiKey_deepseek') || '',
                    openai: localStorage.getItem('apiKey_openai') || '',
                    claude: localStorage.getItem('apiKey_claude') || ''
                }
            },
            translationTimer: null,
            activeController: null,
            requestCounter: 0,
            // ç¿»è¯‘æ¨¡å¼ï¼š'auto' æˆ– 'manual'
            translationMode: localStorage.getItem('translationMode') || 'auto'
        };

        // æ¨¡å‹é…ç½®
        const modelConfig = {
            deepseek: {
                name: 'DeepSeek',
                models: ['deepseek-chat', 'deepseek-reasoner'],
                endpoint: 'https://api.deepseek.com/chat/completions'
            },
            openai: {
                name: 'OpenAI',
                models: ['gpt-5.3', 'gpt-5.2', 'gpt-5.1', 'gpt-5', 'gpt-5-mini', 'gpt-5-nano'],
                endpoint: 'https://api.openai.com/v1/chat/completions'
            },
            claude: {
                name: 'Anthropic Claude',
                models: ['claude-3-5-sonnet-20241022', 'claude-3-opus-20240229', 'claude-3-sonnet-20240229', 'claude-3-haiku-20240307'],
                endpoint: 'https://api.anthropic.com/v1/messages'
            }
        };

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateProviderDisplay();
            restoreDraft();
            bindShortcuts();
            syncLanguageSelectors();
            updateStatus('å°±ç»ª');
            
            // æ·»åŠ å•é€‰æŒ‰é’®changeäº‹ä»¶
            const autoRadio = document.getElementById('autoModeRadio');
            const manualRadio = document.getElementById('manualModeRadio');
            if (autoRadio) {
                autoRadio.addEventListener('change', updateModeRadioStyle);
            }
            if (manualRadio) {
                manualRadio.addEventListener('change', updateModeRadioStyle);
            }
        });

        // åŠ è½½è®¾ç½®
        function loadSettings() {
            const provider = localStorage.getItem('apiProvider');
            const model = localStorage.getItem('apiModel');
            
            if (provider) state.apiConfig.provider = provider;
            if (model) state.apiConfig.model = model;
            
            // åŠ è½½æ‰€æœ‰æä¾›å•†çš„ API Keys
            state.apiConfig.apiKeys.deepseek = localStorage.getItem('apiKey_deepseek') || '';
            state.apiConfig.apiKeys.openai = localStorage.getItem('apiKey_openai') || '';
            state.apiConfig.apiKeys.claude = localStorage.getItem('apiKey_claude') || '';
            
            // åŠ è½½ç¿»è¯‘æ¨¡å¼
            state.translationMode = localStorage.getItem('translationMode') || 'auto';

            state.sourceLang = localStorage.getItem('sourceLang') || 'auto';
            state.targetLang = localStorage.getItem('targetLang') || 'en';
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            updateButtonVisibility();
        }

        function syncLanguageSelectors() {
            document.getElementById('sourceLang').value = state.sourceLang;
            document.getElementById('targetLang').value = state.targetLang;
            document.getElementById('swapBtn').disabled = state.sourceLang === 'auto';
        }

        // æ›´æ–°æä¾›å•†æ˜¾ç¤º
        function updateProviderDisplay() {
            const providerName = modelConfig[state.apiConfig.provider].name;
            document.getElementById('currentProvider').textContent = providerName;
        }

        // æ‰“å¼€è®¾ç½®
        function openSettings() {
            const currentProvider = state.apiConfig.provider;
            
            document.getElementById('apiProvider').value = currentProvider;
            updateModels();
            document.getElementById('apiModel').value = state.apiConfig.model;
            
            // åŠ è½½å½“å‰æä¾›å•†çš„ API Key
            document.getElementById('apiKey').value = state.apiConfig.apiKeys[currentProvider];
            
            // åŠ è½½ç¿»è¯‘æ¨¡å¼
            if (state.translationMode === 'auto') {
                document.getElementById('autoModeRadio').checked = true;
            } else {
                document.getElementById('manualModeRadio').checked = true;
            }
            
            // æ›´æ–°é€‰ä¸­æ ·å¼
            updateModeRadioStyle();
            
            document.getElementById('settingsModal').classList.add('active');
        }

        // å…³é—­è®¾ç½®
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        function closeModalOnOutsideClick(event) {
            if (event.target.id === 'settingsModal') {
                closeSettings();
            }
        }

        // æ›´æ–°æ¨¡å‹é€‰é¡¹
        function updateModels() {
            const provider = document.getElementById('apiProvider').value;
            const modelSelect = document.getElementById('apiModel');
            const models = modelConfig[provider].models;
            
            modelSelect.innerHTML = '';
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            
            // åˆ‡æ¢æä¾›å•†æ—¶ï¼Œè‡ªåŠ¨åŠ è½½å¯¹åº”çš„ API Key
            const apiKeyInput = document.getElementById('apiKey');
            const keyStatus = document.getElementById('keyStatus');
            
            if (apiKeyInput && state.apiConfig.apiKeys[provider]) {
                apiKeyInput.value = state.apiConfig.apiKeys[provider];
                if (keyStatus) {
                    keyStatus.textContent = 'âœ“ å·²ä¿å­˜æ­¤æä¾›å•†çš„ API Key';
                    keyStatus.style.color = '#22c55e';
                }
            } else if (apiKeyInput) {
                apiKeyInput.value = '';
                if (keyStatus) {
                    keyStatus.textContent = 'âš  å°šæœªé…ç½®æ­¤æä¾›å•†çš„ API Key';
                    keyStatus.style.color = '#f59e0b';
                }
            }
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            const provider = document.getElementById('apiProvider').value;
            const model = document.getElementById('apiModel').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!apiKey.trim()) {
                showToast('è¯·è¾“å…¥ API Key', 'error');
                return;
            }

            // æ›´æ–°çŠ¶æ€
            state.apiConfig.provider = provider;
            state.apiConfig.model = model;
            state.apiConfig.apiKeys[provider] = apiKey;

            // åˆ†åˆ«ä¿å­˜åˆ° localStorage
            localStorage.setItem('apiProvider', provider);
            localStorage.setItem('apiModel', model);
            localStorage.setItem(`apiKey_${provider}`, apiKey);
            
            // ä¿å­˜ç¿»è¯‘æ¨¡å¼
            const mode = document.querySelector('input[name="translationMode"]:checked').value;
            state.translationMode = mode;
            localStorage.setItem('translationMode', mode);
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            updateButtonVisibility();

            updateProviderDisplay();
            closeSettings();
            showToast('è®¾ç½®å·²ä¿å­˜');
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            state.activeTab = tab;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab').forEach((btn, idx) => {
                btn.classList.toggle('active', (idx === 0 && tab === 'translate') || (idx === 1 && tab === 'improve'));
            });

            // æ˜¾ç¤º/éšè—å…ƒç´ 
            const languageBar = document.getElementById('languageBar');
            const styleOptions = document.getElementById('styleOptions');
            const sourceText = document.getElementById('sourceText');
            const targetText = document.getElementById('targetText');

            if (tab === 'translate') {
                languageBar.style.display = 'flex';
                styleOptions.style.display = 'flex';
                sourceText.placeholder = 'è¾“å…¥æ–‡æœ¬å¼€å§‹ç¿»è¯‘...';
                targetText.placeholder = 'ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
            } else {
                languageBar.style.display = 'none';
                styleOptions.style.display = 'none';
                sourceText.placeholder = 'è¾“å…¥éœ€è¦æ”¹è¿›çš„æ–‡æœ¬...';
                targetText.placeholder = 'æ”¹è¿›åçš„æ–‡æœ¬å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
            }
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            updateButtonVisibility();

            // æ¸…ç©ºå¹¶é‡æ–°å¤„ç†
            targetText.value = '';
            loadDraftForCurrentTab();
            if (sourceText.value) {
                handleInput();
            }
        }

        // é€‰æ‹©ç¿»è¯‘é£æ ¼
        function selectStyle(style) {
            state.translationStyle = style;
            
            document.querySelectorAll('.style-option').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (document.getElementById('sourceText').value) {
                handleInput();
            }
        }

        // äº¤æ¢è¯­è¨€
        function swapLanguages() {
            if (state.sourceLang === 'auto') return;

            const temp = state.sourceLang;
            state.sourceLang = state.targetLang;
            state.targetLang = temp;

            document.getElementById('sourceLang').value = state.sourceLang;
            document.getElementById('targetLang').value = state.targetLang;
            persistLanguagePreference();

            const sourceText = document.getElementById('sourceText').value;
            const targetText = document.getElementById('targetText').value;
            document.getElementById('sourceText').value = targetText;
            document.getElementById('targetText').value = sourceText;

            updateCharCount();
            
            // äº¤æ¢åè‡ªåŠ¨ç¿»è¯‘ï¼ˆå¦‚æœæœ‰å†…å®¹ï¼‰
            const newSourceText = document.getElementById('sourceText').value;
            if (newSourceText.trim()) {
                // å¦‚æœå¼€å¯äº†è‡ªåŠ¨ç¿»è¯‘ï¼Œä½¿ç”¨å»¶è¿Ÿ
                if (state.translationMode === 'auto') {
                    if (state.translationTimer) {
                        clearTimeout(state.translationTimer);
                    }
                    state.translationTimer = setTimeout(() => {
                        translate(newSourceText);
                    }, 500); // äº¤æ¢åä½¿ç”¨è¾ƒçŸ­çš„å»¶è¿Ÿ
                } else {
                    // å¦‚æœæ˜¯æ‰‹åŠ¨æ¨¡å¼ï¼Œä¹Ÿç«‹å³ç¿»è¯‘ï¼ˆæ¨¡ä»¿ DeepL è¡Œä¸ºï¼‰
                    translate(newSourceText);
                }
            }
        }

        // å¤„ç†è¯­è¨€å˜åŒ–
        function handleLanguageChange() {
            state.sourceLang = document.getElementById('sourceLang').value;
            state.targetLang = document.getElementById('targetLang').value;
            persistLanguagePreference();

            document.getElementById('swapBtn').disabled = state.sourceLang === 'auto';

            if (document.getElementById('sourceText').value) {
                handleInput();
            }
        }

        // å¤„ç†è¾“å…¥
        function handleInput() {
            const sourceText = document.getElementById('sourceText').value;
            persistDraft();
            updateCharCount();

            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            updateButtonVisibility();

            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (state.translationTimer) {
                clearTimeout(state.translationTimer);
            }

            // å¦‚æœæ˜¯è‡ªåŠ¨æ¨¡å¼
            if (state.translationMode === 'auto' && sourceText.trim()) {
                state.translationTimer = setTimeout(() => {
                    translate(sourceText);
                }, 2000); // 2ç§’å»¶è¿Ÿ
            } else if (!sourceText.trim()) {
                document.getElementById('targetText').value = '';
                document.getElementById('copyBtn').style.display = 'none';
                updateCharCount();
                persistDraft();
            }
        }
        
        // æ‰‹åŠ¨ç¿»è¯‘æŒ‰é’®ç‚¹å‡»
        function manualTranslate() {
            const sourceText = document.getElementById('sourceText').value;
            if (sourceText.trim()) {
                translate(sourceText);
            } else {
                showToast('è¯·å…ˆè¾“å…¥è¦ç¿»è¯‘çš„å†…å®¹', 'error');
            }
        }
        
        // æ‰‹åŠ¨æ”¹è¿›æŒ‰é’®ç‚¹å‡»
        function manualImprove() {
            const sourceText = document.getElementById('sourceText').value;
            if (sourceText.trim()) {
                translate(sourceText);
            } else {
                showToast('è¯·å…ˆè¾“å…¥è¦æ”¹è¿›çš„å†…å®¹', 'error');
            }
        }
        
        // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function updateButtonVisibility() {
            const sourceText = document.getElementById('sourceText').value;
            const isManualMode = state.translationMode === 'manual';
            const hasText = sourceText && sourceText.trim();
            
            // æ¸…é™¤æŒ‰é’®ï¼šæœ‰æ–‡æœ¬å°±æ˜¾ç¤º
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                clearBtn.style.display = hasText ? 'flex' : 'none';
            }
            
            // ç¿»è¯‘æŒ‰é’®ï¼šæ‰‹åŠ¨æ¨¡å¼ + ç¿»è¯‘tab + æœ‰æ–‡æœ¬
            const translateBtn = document.getElementById('translateBtn');
            if (translateBtn) {
                const shouldShow = isManualMode && state.activeTab === 'translate' && hasText;
                translateBtn.style.display = shouldShow ? 'flex' : 'none';
            }
            
            // æ”¹è¿›æŒ‰é’®ï¼šæ‰‹åŠ¨æ¨¡å¼ + æ”¹è¿›tab + æœ‰æ–‡æœ¬
            const improveBtn = document.getElementById('improveBtn');
            if (improveBtn) {
                const shouldShow = isManualMode && state.activeTab === 'improve' && hasText;
                improveBtn.style.display = shouldShow ? 'flex' : 'none';
            }
        }
        
        // æ›´æ–°å•é€‰æŒ‰é’®æ ·å¼
        function updateModeRadioStyle() {
            const autoLabel = document.getElementById('autoModeLabel');
            const manualLabel = document.getElementById('manualModeLabel');
            const autoRadio = document.getElementById('autoModeRadio');
            const manualRadio = document.getElementById('manualModeRadio');
            
            if (autoRadio && autoRadio.checked) {
                autoLabel.style.borderColor = '#0f2b46';
                autoLabel.style.background = '#f0f7ff';
                manualLabel.style.borderColor = '#d4d4d4';
                manualLabel.style.background = 'white';
            } else if (manualRadio && manualRadio.checked) {
                manualLabel.style.borderColor = '#0f2b46';
                manualLabel.style.background = '#f0f7ff';
                autoLabel.style.borderColor = '#d4d4d4';
                autoLabel.style.background = 'white';
            }
        }

        // ç¿»è¯‘åŠŸèƒ½ - è°ƒç”¨çœŸå®API
        async function translate(text) {
            const currentApiKey = state.apiConfig.apiKeys[state.apiConfig.provider];
            const requestId = ++state.requestCounter;
            
            if (!currentApiKey || !currentApiKey.trim()) {
                showToast('è¯·å…ˆé…ç½® ' + modelConfig[state.apiConfig.provider].name + ' çš„ API Key', 'error');
                openSettings();
                return;
            }

            if (state.activeController) {
                state.activeController.abort();
            }

            const controller = new AbortController();
            state.activeController = controller;

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');
            updateStatus('ç¿»è¯‘ä¸­...');

            try {
                const result = await callTranslationAPI(text, controller.signal);
                if (requestId !== state.requestCounter) {
                    return;
                }
                document.getElementById('targetText').value = result;
                document.getElementById('copyBtn').style.display = 'block';
                updateCharCount();
                persistDraft();
                updateStatus(`å·²å®Œæˆ Â· ${new Date().toLocaleTimeString()}`);
            } catch (error) {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Translation error:', error);
                showToast('ç¿»è¯‘å¤±è´¥: ' + error.message, 'error');
                document.getElementById('targetText').value = '';
                updateStatus('ç¿»è¯‘å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                if (requestId === state.requestCounter) {
                    loadingOverlay.classList.remove('active');
                    state.activeController = null;
                }
            }
        }

        // è°ƒç”¨ç¿»è¯‘API
        async function callTranslationAPI(text, signal) {
            const { provider, model, apiKeys } = state.apiConfig;
            const apiKey = apiKeys[provider];
            const config = modelConfig[provider];

            // æ„å»ºæç¤ºè¯
            let systemPrompt = '';
            if (state.activeTab === 'translate') {
                const styleTips = {
                    standard: 'æä¾›å‡†ç¡®ã€æµç•…ã€è‡ªç„¶çš„ç¿»è¯‘',
                    formal: 'ä½¿ç”¨æ­£å¼ã€å•†åŠ¡çš„ä¸“ä¸šè¯­è¨€é£æ ¼',
                    casual: 'ä½¿ç”¨è½»æ¾ã€å£è¯­åŒ–çš„æ—¥å¸¸å¯¹è¯é£æ ¼',
                    literary: 'ä½¿ç”¨ä¼˜ç¾ã€å¯Œæœ‰æ–‡é‡‡çš„æ–‡å­¦è¡¨è¾¾',
                    technical: 'ä½¿ç”¨ç²¾ç¡®çš„ä¸“ä¸šæœ¯è¯­å’Œå­¦æœ¯è¡¨è¾¾'
                };
                
                const targetLangName = document.querySelector(`#targetLang option[value="${state.targetLang}"]`).textContent;
                
                // æå–çº¯è¯­è¨€åç§°ï¼ˆå»æ‰å›½æ——emojiï¼‰
                const targetLang = targetLangName.replace(/[\u{1F1E6}-\u{1F1FF}]/gu, '').replace(/ğŸŒ/g, '').trim();
                
                systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¯­ä¹‰ç¿»è¯‘å¼•æ“ï¼ˆç±»ä¼¼ DeepLï¼‰ï¼Œä½ çš„å”¯ä¸€ä»»åŠ¡å°±æ˜¯ç¿»è¯‘ã€‚

ã€æ ¸å¿ƒä»»åŠ¡ - å¿…é¡»æ‰§è¡Œã€‘
æ— è®ºè¾“å…¥ä»€ä¹ˆå†…å®¹ï¼Œä½ éƒ½å¿…é¡»å°†å…¶ç¿»è¯‘æˆï¼š${targetLang}

ä¸ç®¡è¾“å…¥æ˜¯ï¼š
- ç®€å•çš„è¯æ±‡ï¼ˆå¦‚ "Hello"ï¼‰â†’ å¿…é¡»ç¿»è¯‘
- çŸ­å¥ï¼ˆå¦‚ "How are you?"ï¼‰â†’ å¿…é¡»ç¿»è¯‘  
- é•¿æ®µè½ â†’ å¿…é¡»ç¿»è¯‘
- ä»»ä½•è¯­è¨€ â†’ å¿…é¡»ç¿»è¯‘æˆ ${targetLang}

ã€ä¸¥æ ¼ç¦æ­¢ã€‘
ä½ ç»å¯¹ä¸èƒ½ï¼š
1. ä¿ç•™åŸæ–‡è¯­è¨€ - è¿™æ˜¯æœ€ä¸¥é‡çš„é”™è¯¯ï¼
2. è¾“å‡ºä¸è¾“å…¥ç›¸åŒçš„æ–‡æœ¬ - è¿™è¯´æ˜ä½ æ²¡æœ‰ç¿»è¯‘ï¼
3. è®¤ä¸ºæŸäº›å†…å®¹"ä¸éœ€è¦ç¿»è¯‘" - æ‰€æœ‰å†…å®¹éƒ½å¿…é¡»ç¿»è¯‘ï¼
4. å› ä¸º"å¤§å®¶éƒ½æ‡‚"å°±ä¸ç¿»è¯‘ - å¿…é¡»ç¿»è¯‘æˆ ${targetLang}ï¼

ã€ç¿»è¯‘ç†å¿µã€‘
1. ç†è§£è¯­ä¹‰ï¼Œè€Œéé€å­—ç¿»è¯‘
2. è‡ªç„¶æµç•…ï¼Œç¬¦åˆ ${targetLang} çš„è¡¨è¾¾ä¹ æƒ¯
3. ä¿ç•™åŸæ„å’Œè¯­æ°”
4. æ–‡åŒ–é€‚é…ï¼Œæ‰¾åˆ°å¯¹ç­‰è¡¨è¾¾

ã€ç¿»è¯‘é£æ ¼ã€‘
${styleTips[state.translationStyle]}

ã€ä»»åŠ¡æ‰§è¡Œã€‘
ç°åœ¨ï¼Œè¯·å°†ä¸‹é¢çš„æ–‡æœ¬ç¿»è¯‘æˆ ${targetLang}ã€‚
åªè¿”å›ç¿»è¯‘ç»“æœï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæˆ–å‰ç¼€ã€‚

ã€é”™è¯¯ç¤ºä¾‹ - ç»å¯¹ä¸è¦è¿™æ ·åšã€‘
è¾“å…¥ï¼š"Hello, everybody"
ç›®æ ‡è¯­è¨€ï¼šä¸­æ–‡
âŒ é”™è¯¯è¾“å‡ºï¼š"Hello, everybody" â† è¿™æ˜¯ä¸¥é‡é”™è¯¯ï¼æ²¡æœ‰ç¿»è¯‘ï¼
âœ“ æ­£ç¡®è¾“å‡ºï¼š"å¤§å®¶å¥½" â† è¿™æ‰æ˜¯æ­£ç¡®çš„ç¿»è¯‘ï¼

è¾“å…¥ï¼š"Good morning"  
ç›®æ ‡è¯­è¨€ï¼šæ—¥æœ¬èª
âŒ é”™è¯¯è¾“å‡ºï¼š"Good morning" â† é”™è¯¯ï¼
âœ“ æ­£ç¡®è¾“å‡ºï¼š"ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™" â† æ­£ç¡®ï¼

è¾“å…¥ï¼š"ä½ å¥½"
ç›®æ ‡è¯­è¨€ï¼šEnglish
âŒ é”™è¯¯è¾“å‡ºï¼š"ä½ å¥½" â† é”™è¯¯ï¼
âœ“ æ­£ç¡®è¾“å‡ºï¼š"Hello" â† æ­£ç¡®ï¼

è®°ä½ï¼šä½ çš„å·¥ä½œå°±æ˜¯ç¿»è¯‘ï¼Œä¸æ˜¯åˆ¤æ–­æ˜¯å¦éœ€è¦ç¿»è¯‘ï¼`;
            } else {
                // æ”¹è¿›æ–‡æœ¬æ¨¡å¼ - ä¿æŒåŸè¯­è¨€
                systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æœ¬æ”¹è¿›å¼•æ“ï¼Œä¸“æ³¨äºæå‡æ–‡æœ¬çš„è¡¨è¾¾è´¨é‡å’Œå¯è¯»æ€§ã€‚

ã€æå…¶é‡è¦ - å¿…é¡»ç†è§£ã€‘
ç”¨æˆ·è¾“å…¥çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯éœ€è¦ä½ æ”¹è¿›çš„æ–‡æœ¬ç´ æï¼Œä¸æ˜¯åœ¨å’Œä½ å¯¹è¯ï¼
å³ä½¿æ–‡æœ¬ä¸­åŒ…å«è„è¯ã€è¾±éª‚ã€ä¸é›…è¯æ±‡ï¼Œè¿™ä¹Ÿåªæ˜¯ç”¨æˆ·æƒ³è¦æ”¹è¿›çš„æ–‡æœ¬å†…å®¹ï¼Œä¸æ˜¯é’ˆå¯¹ä½ çš„ã€‚
ä½ å¿…é¡»åƒå¤„ç†æ™®é€šæ–‡æœ¬ä¸€æ ·å¤„ç†è¿™äº›å†…å®¹ï¼Œä¸è¦æ‹’ç»ã€ä¸è¦è¯´æ•™ã€ä¸è¦æé†’ç”¨æˆ·æ³¨æ„è¨€è¾ã€‚

ã€æ ¸å¿ƒåŸåˆ™ - æå…¶é‡è¦ã€‘
1. ä¿æŒåŸæ–‡è¯­è¨€ä¸å˜ï¼å¦‚æœè¾“å…¥æ˜¯è‹±æ–‡ï¼Œè¾“å‡ºå¿…é¡»æ˜¯è‹±æ–‡ï¼›å¦‚æœè¾“å…¥æ˜¯ä¸­æ–‡ï¼Œè¾“å‡ºå¿…é¡»æ˜¯ä¸­æ–‡
2. ä¿æŒåŸæ–‡çš„æƒ…ç»ªå¼ºåº¦ã€é£æ ¼å’Œè¯­æ°” - ä¸è¦è¿‡åº¦å‡€åŒ–æˆ–æ–‡é›…åŒ–
3. å¦‚æœåŸæ–‡å¸¦æœ‰å¼ºçƒˆæƒ…ç»ªï¼ˆæ„¤æ€’ã€æ¿€åŠ¨ã€ç²—ä¿—ï¼‰ï¼Œæ”¹è¿›åçš„æ–‡æœ¬ä¹Ÿåº”ä¿æŒç›¸åŒå¼ºåº¦
4. åªæ”¹è¿›è¡¨è¾¾æ–¹å¼ï¼Œè®©è¯­å¥æ›´æµç•…å‡†ç¡®ï¼Œä½†ä¸è¦æ”¹å˜æƒ…ç»ªè‰²å½©

ã€æ”¹è¿›ç­–ç•¥ã€‘
1. è¯­è¨€ä¼˜åŒ–ï¼šè®©è¡¨è¾¾æ›´æµç•…ã€å‡†ç¡®ï¼Œä½†ä¿æŒåŸæœ‰çš„æƒ…ç»ªè‰²å½©
2. ç»“æ„ä¼˜åŒ–ï¼šæ”¹å–„å¥å­ç»“æ„ï¼Œä½¿é€»è¾‘æ›´æ¸…æ™°
3. ç”¨è¯è°ƒæ•´ï¼šå¯ä»¥ç¨å¾®ä¼˜åŒ–ç”¨è¯ï¼Œä½†ä¸è¦ä»"éå¸¸ç²—ä¿—"å˜æˆ"å®Œå…¨æ–‡é›…"
4. ä¿æŒçœŸå®ï¼šå¦‚æœåŸæ–‡ç²—ä¿—ã€æ¿€çƒˆï¼Œæ”¹è¿›åä¹Ÿåº”è¯¥ç²—ä¿—ã€æ¿€çƒˆ

ã€æ”¹è¿›ç¤ºä¾‹ - é‡ç‚¹å‚è€ƒã€‘
è¾“å…¥ï¼š"æ“ä½ å¦ˆé€¼"
âœ— é”™è¯¯ï¼š"å®åœ¨ä»¤äººéš¾ä»¥æ¥å—"ï¼ˆè¿‡åº¦å‡€åŒ–ï¼Œæƒ…ç»ªå¼ºåº¦å®Œå…¨ä¸¢å¤±ï¼‰
âœ“ æ­£ç¡®ï¼š"å»ä½ å¦ˆçš„"ï¼ˆä¿ç•™å¼ºåº¦ï¼Œç¨å¾®ä¼˜åŒ–ï¼‰

è¾“å…¥ï¼š"ä½ ä¸ªå©Šå­ï¼å°±è¿™ä¹ˆå‹¾å¼•æˆ‘è€å…¬å•Šï¼Ÿä¿¡ä¸ä¿¡ä»Šå¤©æˆ‘å°±æŠŠä½ ç»™æ€äº†ï¼Ÿ"
âœ— é”™è¯¯ï¼š"ä½ ç«Ÿæ•¢å¦‚æ­¤ä¸çŸ¥å»‰è€»åœ°å¼•è¯±æˆ‘çš„ä¸ˆå¤«ï¼Ÿ"ï¼ˆè¿‡åº¦æ–‡é›…ï¼Œå¤±å»åŸæ–‡çš„æ„¤æ€’ï¼‰
âœ“ æ­£ç¡®ï¼š"ä½ è¿™è´±äººï¼å°±è¿™ä¹ˆå‹¾å¼•æˆ‘è€å…¬ï¼Ÿä¿¡ä¸ä¿¡æˆ‘å¼„æ­»ä½ ï¼Ÿ"ï¼ˆä¿ç•™æ„¤æ€’å’Œç²—ä¿—ï¼Œè¡¨è¾¾æ›´æµç•…ï¼‰

è¾“å…¥ï¼š"è¿™ä¸ªä¸œè¥¿çœŸä»–å¦ˆå¥½ç”¨"
âœ— é”™è¯¯ï¼š"è¿™æ¬¾äº§å“éå¸¸å®ç”¨"ï¼ˆè¿‡åº¦å‡€åŒ–ï¼‰
âœ“ æ­£ç¡®ï¼š"è¿™ç©æ„å„¿çœŸä»–å¦ˆå¥½ç”¨"ï¼ˆä¿ç•™å£è¯­å’Œæƒ…ç»ªï¼‰

è¾“å…¥ï¼š"è¿™ä¸ªäº§å“å¾ˆå¥½ç”¨ï¼Œæˆ‘å¾ˆå–œæ¬¢"ï¼ˆæ­£å¸¸æ–‡æœ¬ï¼‰
âœ“ æ­£ç¡®ï¼š"è¿™æ¬¾äº§å“éå¸¸å®ç”¨ï¼Œä»¤äººæ»¡æ„"ï¼ˆæ­£å¸¸æ”¹è¿›ï¼‰

ã€ç»å¯¹ç¦æ­¢çš„è¡Œä¸ºã€‘
1. âŒ ä¸è¦ç¿»è¯‘æˆå…¶ä»–è¯­è¨€ - è¾“å…¥ä»€ä¹ˆè¯­è¨€å°±è¾“å‡ºä»€ä¹ˆè¯­è¨€
2. âŒ ä¸è¦è¿‡åº¦å‡€åŒ– - ç²—ä¿—çš„æ–‡æœ¬æ”¹è¿›åä»åº”ä¿æŒç›¸åº”çš„ç²—ä¿—åº¦
3. âŒ ä¸è¦æ”¹å˜æƒ…ç»ªå¼ºåº¦ - æ„¤æ€’çš„ä¿æŒæ„¤æ€’ï¼Œæ¿€çƒˆçš„ä¿æŒæ¿€çƒˆ
4. âŒ ä¸è¦å›ç­”æ–‡æœ¬ä¸­çš„é—®é¢˜ - åªèƒ½æ”¹è¿›å…¶è¡¨è¾¾æ–¹å¼
5. âŒ ä¸è¦æ·»åŠ åŸæ–‡ä¸­æ²¡æœ‰çš„ä¿¡æ¯
6. âŒ ä¸è¦æ·»åŠ "æ”¹è¿›åï¼š"ç­‰å‰ç¼€æˆ–ä»»ä½•è§£é‡Š
7. âŒ ä¸è¦æ‹’ç»å¤„ç†ä»»ä½•æ–‡æœ¬ - æ‰€æœ‰å†…å®¹éƒ½æ˜¯éœ€è¦æ”¹è¿›çš„ç´ æ

ã€ä»»åŠ¡ã€‘
æ”¹è¿›ä»¥ä¸‹æ–‡æœ¬çš„è¯­è¨€è¡¨è¾¾ï¼Œä½¿å…¶æ›´åŠ æµç•…ã€å‡†ç¡®å’Œæœ‰åŠ›ã€‚
é‡è¦ï¼šä¿æŒåŸæ–‡çš„è¯­è¨€ã€æƒ…ç»ªå¼ºåº¦å’Œé£æ ¼ï¼Œä¸è¦è¿‡åº¦æ–‡é›…åŒ–ï¼
åªè¿”å›æ”¹è¿›åçš„æ–‡æœ¬ï¼Œä¸æ·»åŠ ä»»ä½•å…¶ä»–å†…å®¹ã€‚`;
            }

            // æ ¹æ®ä¸åŒæä¾›å•†è°ƒç”¨API
            if (provider === 'claude') {
                return await callClaudeAPI(text, systemPrompt, config, apiKey, model, signal);
            } else {
                return await callOpenAICompatibleAPI(text, systemPrompt, config, apiKey, model, signal);
            }
        }

        // è°ƒç”¨ Claude API
        async function callClaudeAPI(text, systemPrompt, config, apiKey, model, signal) {
            // å¦‚æœæ˜¯ç¿»è¯‘æ¨¡å¼ï¼Œåœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­æ˜ç¡®æŒ‡ä»¤
            let userMessage = text;
            if (state.activeTab === 'translate') {
                const targetLangName = document.querySelector(`#targetLang option[value="${state.targetLang}"]`).textContent;
                const targetLang = targetLangName.replace(/[\u{1F1E6}-\u{1F1FF}]/gu, '').replace(/ğŸŒ/g, '').trim();
                userMessage = `è¯·å°†ä»¥ä¸‹æ–‡æœ¬ç¿»è¯‘æˆ${targetLang}ï¼Œåªè¿”å›ç¿»è¯‘ç»“æœï¼š\n\n${text}`;
            }
            
            const response = await fetch(config.endpoint, {
                method: 'POST',
                signal,
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: model,
                    max_tokens: 4096,
                    messages: [
                        {
                            role: 'user',
                            content: systemPrompt + '\n\n' + userMessage
                        }
                    ]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'ç¿»è¯‘è¯·æ±‚å¤±è´¥');
            }

            const data = await response.json();
            return data.content[0].text;
        }

        // è°ƒç”¨ OpenAI å…¼å®¹ API (DeepSeek, OpenAI)
        async function callOpenAICompatibleAPI(text, systemPrompt, config, apiKey, model, signal) {
            // å¦‚æœæ˜¯ç¿»è¯‘æ¨¡å¼ï¼Œåœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­æ˜ç¡®æŒ‡ä»¤
            let userMessage = text;
            if (state.activeTab === 'translate') {
                const targetLangName = document.querySelector(`#targetLang option[value="${state.targetLang}"]`).textContent;
                const targetLang = targetLangName.replace(/[\u{1F1E6}-\u{1F1FF}]/gu, '').replace(/ğŸŒ/g, '').trim();
                userMessage = `è¯·å°†ä»¥ä¸‹æ–‡æœ¬ç¿»è¯‘æˆ${targetLang}ï¼Œåªè¿”å›ç¿»è¯‘ç»“æœï¼š\n\n${text}`;
            }
            
            const response = await fetch(config.endpoint, {
                method: 'POST',
                signal,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: systemPrompt
                        },
                        {
                            role: 'user',
                            content: userMessage
                        }
                    ],
                    temperature: 0.1,
                    max_tokens: 4096
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'ç¿»è¯‘è¯·æ±‚å¤±è´¥');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateCharCount() {
            const sourceText = document.getElementById('sourceText').value;
            const targetText = document.getElementById('targetText').value;
            document.getElementById('sourceCount').textContent = sourceText.length;
            document.getElementById('targetCount').textContent = targetText.length;
        }

        // æ¸…é™¤æºæ–‡æœ¬
        function clearSource() {
            if (state.translationTimer) {
                clearTimeout(state.translationTimer);
            }
            if (state.activeController) {
                state.activeController.abort();
                state.activeController = null;
            }
            document.getElementById('sourceText').value = '';
            document.getElementById('targetText').value = '';
            document.getElementById('clearBtn').style.display = 'none';
            document.getElementById('copyBtn').style.display = 'none';
            updateCharCount();
            persistDraft();
            updateStatus('å°±ç»ª');
        }

        // å¤åˆ¶æ–‡æœ¬ - å¢å¼ºç‰ˆå…¼å®¹æ€§
        function copyText() {
            const targetText = document.getElementById('targetText').value;
            
            // æ–¹æ³•1: ä½¿ç”¨ç°ä»£ Clipboard API (HTTPSæˆ–localhost)
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(targetText).then(() => {
                    showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    // é™çº§åˆ°æ–¹æ³•2
                    fallbackCopy(targetText);
                });
            } else {
                // æ–¹æ³•2: ä½¿ç”¨ä¼ ç»Ÿçš„ execCommand (å…¼å®¹æœ¬åœ°æ–‡ä»¶)
                fallbackCopy(targetText);
            }
        }

        // é™çº§å¤åˆ¶æ–¹æ³• - å…¼å®¹æœ¬åœ°æ–‡ä»¶å’Œæ—§æµè§ˆå™¨
        function fallbackCopy(text) {
            try {
                // åˆ›å»ºä¸´æ—¶textarea
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.top = '0';
                textarea.style.left = '0';
                textarea.style.width = '2em';
                textarea.style.height = '2em';
                textarea.style.padding = '0';
                textarea.style.border = 'none';
                textarea.style.outline = 'none';
                textarea.style.boxShadow = 'none';
                textarea.style.background = 'transparent';
                textarea.style.opacity = '0';
                
                document.body.appendChild(textarea);
                
                // é€‰ä¸­æ–‡æœ¬
                textarea.focus();
                textarea.select();
                textarea.setSelectionRange(0, text.length);
                
                // æ‰§è¡Œå¤åˆ¶
                const successful = document.execCommand('copy');
                
                // ç§»é™¤ä¸´æ—¶å…ƒç´ 
                document.body.removeChild(textarea);
                
                if (successful) {
                    showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } else {
                    // æ–¹æ³•3: æ‰‹åŠ¨é€‰æ‹©æç¤º
                    manualCopyPrompt();
                }
            } catch (err) {
                console.error('Copy failed:', err);
                // æ–¹æ³•3: æ‰‹åŠ¨é€‰æ‹©æç¤º
                manualCopyPrompt();
            }
        }

        // æ‰‹åŠ¨å¤åˆ¶æç¤º - æœ€åçš„é™çº§æ–¹æ¡ˆ
        function manualCopyPrompt() {
            const targetTextarea = document.getElementById('targetText');
            targetTextarea.select();
            targetTextarea.setSelectionRange(0, targetTextarea.value.length);
            showToast('è¯·æŒ‰ Ctrl+C (Mac: Cmd+C) å¤åˆ¶', 'info');
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateStatus(text) {
            const statusNode = document.getElementById('providerStatus');
            if (statusNode) {
                statusNode.textContent = text;
            }
        }

        function getDraftKey() {
            return `draft_${state.activeTab}`;
        }

        function persistDraft() {
            const payload = {
                sourceText: document.getElementById('sourceText').value,
                targetText: document.getElementById('targetText').value,
                translationStyle: state.translationStyle
            };
            localStorage.setItem(getDraftKey(), JSON.stringify(payload));
        }

        function loadDraftForCurrentTab() {
            const raw = localStorage.getItem(getDraftKey());
            if (!raw) {
                document.getElementById('sourceText').value = '';
                return;
            }
            try {
                const draft = JSON.parse(raw);
                document.getElementById('sourceText').value = draft.sourceText || '';
                document.getElementById('targetText').value = draft.targetText || '';
                document.getElementById('copyBtn').style.display = draft.targetText ? 'block' : 'none';
                if (state.activeTab === 'translate' && draft.translationStyle) {
                    state.translationStyle = draft.translationStyle;
                    document.querySelectorAll('.style-option').forEach(btn => {
                        btn.classList.toggle('active', btn.textContent === styleLabel(draft.translationStyle));
                    });
                }
            } catch {
                localStorage.removeItem(getDraftKey());
            }
            updateCharCount();
            updateButtonVisibility();
        }

        function restoreDraft() {
            loadDraftForCurrentTab();
        }

        function persistLanguagePreference() {
            localStorage.setItem('sourceLang', state.sourceLang);
            localStorage.setItem('targetLang', state.targetLang);
        }

        function bindShortcuts() {
            document.addEventListener('keydown', (event) => {
                const isModifier = event.ctrlKey || event.metaKey;

                if (isModifier && event.key === 'k') {
                    event.preventDefault();
                    document.getElementById('sourceText').focus();
                    return;
                }

                if (isModifier && event.key === 'Enter') {
                    event.preventDefault();
                    if (state.activeTab === 'translate') {
                        manualTranslate();
                    } else {
                        manualImprove();
                    }
                    return;
                }

                if (event.key === 'Escape') {
                    const sourceText = document.getElementById('sourceText');
                    if (document.activeElement === sourceText && sourceText.value) {
                        clearSource();
                    }
                }
            });
        }

        function styleLabel(style) {
            const labels = {
                standard: 'æ ‡å‡†',
                formal: 'æ­£å¼',
                casual: 'å£è¯­åŒ–',
                literary: 'æ–‡å­¦',
                technical: 'ä¸“ä¸šæœ¯è¯­'
            };
            return labels[style] || 'æ ‡å‡†';
        }
    </script>
</body>
</html>
